<section class="page">
  <h2>Listado de reservas</h2>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar__row toolbar__row--top">
      <button *ngIf="rol === 'Usuario'" class="btn-primary"
              [routerLink]="'/catalogo'"
              [queryParams]="{ from:'reservas', nueva:1 }">
        <span class="material-symbols-rounded">add</span> Nueva Reserva
      </button>
    </div>

    <div class="toolbar__row toolbar__row--filters">
      <!-- Calendario -->
      <label class="search">
        <input type="date" #f (change)="cambiarFecha(f.value)">
        <span class="material-symbols-rounded" (click)="abrirCalendario(f)">calendar_month</span>
      </label>

      <!-- Estado -->
      <label class="estado">
        <span class="estado__text">Estado:</span>
        <select #s (change)="cambiarEstado(s.value)">
          <option value="">Todas</option>
          <option value="pendiente">Pendiente</option>
          <option value="expirada">Expirada</option>
          <option value="cumplida">Cumplida</option>
        </select>
        <span class="material-symbols-rounded">expand_more</span>
      </label>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card table-wrap">
    <table class="tabla">
      <thead>
        <tr>
          <th>Código</th>
          <th>Fecha Reserva</th>
          <th>Tipo de recurso</th>
          <th>Título</th>
          <th *ngIf="rol !== 'Usuario'">Usuario</th>
          <th *ngIf="rol !== 'Usuario'">Notificación</th>
          <th *ngIf="rol !== 'Usuario'">Bibliotecario</th>
          <th *ngIf="rol !== 'Usuario'">Penalidades</th>
          <th>Estado</th>
          <th *ngIf="rol === 'Usuario'">Detalle</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of reservasPaginadas; trackBy: trackByReservaId">
          <td>{{ codigo(r.id) }}</td>
          <td>{{ r.fechaReserva | date:'dd/MM/yyyy' }}</td>
          <td>{{ r.tipoRecurso }}</td>
          <td class="ellipsis">{{ r.recurso }}</td>

          <td *ngIf="rol !== 'Usuario'">{{ r.usuario || '—' }}</td>
          <td *ngIf="rol !== 'Usuario'">{{ r.notificado ? 'Sí' : 'No' }}</td>
          <td *ngIf="rol !== 'Usuario'">{{ r.notificadoPor || '-' }}</td>
          <td *ngIf="rol !== 'Usuario'">{{ r.penalidades || '—' }}</td>
          <td>
            <span class="badge"
                  [class.is-cumplida]="(r.estado | lowercase) === 'cumplida'"
                  [class.is-expirada]="(r.estado | lowercase) === 'expirada'"
                  [class.is-pendiente]="(r.estado | lowercase) === 'pendiente'">
              {{ labelEstado(r.estado) }}
            </span>
          </td>

          <td class="center" *ngIf="rol === 'Usuario'">
            <button class="icon icon--view" title="Ver detalle" (click)="verDetalle(r)">
              <span class="material-symbols-rounded">visibility</span>
            </button>
          </td>

          <td class="center">
            <ng-container *ngIf="rol === 'Usuario'; else adminAcciones">
              <button class="icon icon--badge" title="Cancelar libro" (click)="pedirCancelar(r)">
                <span class="material-symbols-rounded base">menu_book</span>
                <span class="material-symbols-rounded badge">close</span>
              </button>
              <button class="icon icon--download" title="Descargar comprobante" (click)="descargar(r)">
                <span class="material-symbols-rounded">download</span>
              </button>
            </ng-container>
            <ng-template #adminAcciones>
             <button class="icon icon--approve" title="Aprobar reserva" (click)="abrirConfirmacion(r)">
              <span class="material-symbols-rounded">check_circle</span>
            </button>
              <button class="icon icon--download" title="Descargar comprobante" (click)="descargar(r)">
                <span class="material-symbols-rounded">download</span>
              </button>
            </ng-template>
          </td>
        </tr>

        <tr *ngIf="amodelreserva.length === 0">
          <td [attr.colspan]="rol === 'Usuario' ? 7 : 9" class="center muted">
            Sin resultados
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Paginador -->
    <div class="pager" *ngIf="reservasPaginadas.length > 0">
      <nav class="pager__nav">
        <button class="pg-btn" (click)="prev()" [disabled]="pageIndex === 1">
          <span class="material-symbols-rounded">chevron_left</span>
        </button>

        <button *ngFor="let p of pages" class="pg-btn"
                [class.is-active]="p === pageIndex"
                (click)="goToPage(p)">
          {{ p }}
        </button>

        <button class="pg-btn" (click)="next()" [disabled]="pageIndex === totalPages">
          <span class="material-symbols-rounded">chevron_right</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- MODAL: Confirmar cancelación -->
  <div *ngIf="mostrarConfirmar && seleccion">
    <div class="modal-backdrop" (click)="cerrarTodo()"></div>

    <div class="modal card modal--danger"
         role="dialog" aria-modal="true"
         aria-labelledby="modal-cancelar-head" aria-describedby="modal-cancelar-desc"
         tabindex="0" (keydown.escape)="cerrarTodo()"
         (click)="$event.stopPropagation()">

      <div class="modal__head" id="modal-cancelar-head">Cancelar Reserva</div>

      <div class="modal__body" id="modal-cancelar-desc">
        <p>Se cancelará la reserva de:</p>
        <p class="danger">
          <strong>Recurso:</strong> {{ seleccion.tipoRecurso }} — “{{ seleccion.recurso }}”
        </p>
      </div>
      
      <div *ngIf="error" class="alert alert-error">
        {{ error }}
      </div>
      <div *ngIf="success" class="alert alert-success">
        Reserva cancelada correctamente.
      </div>
      <div class="actions">
        <button class="btn-danger" (click)="cancelar()">Confirmar</button>
        <button class="btn-ghost" (click)="cerrarTodo()">Regresar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Detalle reserva -->
  <div *ngIf="seleccion && !mostrarConfirmar">
    <div class="modal-backdrop" (click)="cerrarTodo()"></div>

    <div class="modal card modal--compact" (click)="$event.stopPropagation()">
      <button class="modal__close" (click)="cerrarTodo()" aria-label="Cerrar">
        <span class="material-symbols-rounded">close</span>
      </button>

       <div class="detalle det--compact">
      <!-- Col izquierda: imagen -->
      <div class="det__left">
        <div class="thumb">
          <img [src]="seleccion.portadaUrl || 'assets/cover-placeholder.png'" alt="Portada" loading="lazy">
          <span *ngIf="!seleccion.portadaUrl" class="material-symbols-rounded placeholder">image</span>
        </div>
      </div>

      <div class="detalle det--compact">
        <div class="det__right">
          <dl class="dl dl--tight">
            <div><dt>Título:</dt>             <dd>{{ seleccion.recurso }}</dd></div>
            <div><dt>Tipo recurso:</dt>       <dd>{{ seleccion.tipoRecurso }}</dd></div>
            <div><dt>Código:</dt>             <dd>{{ codigo(seleccion.id) }}</dd></div>
            <div><dt>Fecha reserva:</dt>      <dd>{{ seleccion.fechaReserva | date:'dd/MM/yyyy' }}</dd></div>
            <div><dt>Fecha expiración:</dt>   <dd>{{ seleccion.fechaExpiracion | date:'dd/MM/yyyy' }}</dd></div>
            <div><dt>Notificado:</dt>         <dd>{{ seleccion.notificado ? 'Sí' : 'No' }}</dd></div>
            <div><dt>Fecha notificación:</dt> 
              <dd>{{ (seleccion.notificado && seleccion.fechaNotificacion) 
                      ? (seleccion.fechaNotificacion | date:'dd/MM/yyyy') 
                      : '—' }}</dd>
            </div>
          </dl>
        </div>
      </div>
    </div>
  </div>

<!-- MODAL: Confirmación de aprobación -->
  <div *ngIf="mostrarConfirmar1 && seleccion1">
  <div class="modal-backdrop" (click)="cerrarTodo()"></div>

  <div class="modal card modal--success" (click)="$event.stopPropagation()">
    <div class="modal__head">Aprobar Reserva</div>

    <div class="modal__body">
      <p>Se aprobará la reserva de:</p>
      <p class="success">
        <strong>Recurso:</strong> {{ seleccion1.tipoRecurso }} — “{{ seleccion1.recurso }}”
      </p>
    </div>

    <div class="actions">
      <button class="btn-primary" (click)="confirmarAprobacion()">Confirmar</button>
      <button class="btn-ghost" (click)="cerrarTodo()">Regresar</button>
    </div>
  </div>
</div>
